# ⚠️ 懸念事項・改善点

リファクタリングの進捗、パフォーマンス/セキュリティ上の懸念、既知の問題、将来計画を俯瞰するためのドキュメントです。優先度の高いタスクから順に記載しています。

---

## 1. リファクタリング状況

### 1.1 ファイル別ステータス

| ファイル | 行数 | 目安 | 超過率 | 優先度 | 状態 |
| --- | --- | --- | --- | --- | --- |
| `Header.tsx` | 194 | 200 | - | - | ✅ 完了（570 → 194 行） |
| `admin/page.tsx` | 132 | 200 | - | - | ✅ 完了（508 → 132 行） |
| `api/materials/[id]/route.ts` | 26 | 300 | - | - | ✅ 完了（485 → 26 行） |
| `MaterialsSearchTab.tsx` | 254 | 200 | 127% | 低 | ✅ 完了（480 → 254 行） |
| `MaterialLibraryBrowser.tsx` | 246 | 300 | - | - | ✅ 完了（766 → 246 行） |
| `overview/page.tsx` | 139 | 200 | - | - | ✅ 完了（835 → 139 行） |
| `materials/page.tsx` | 274 | 200 | 137% | 低 | ✅ 完了（リファクタリング済み） |

### 1.2 コメント

- 完了済みファイルはコンポーネント分割やカスタムフック化で設計指針（1ファイル 200～300 行）に収まりました。
- `materials/page.tsx` は既にリファクタリング完了。`useMaterialsPageTabs`, `useMaterialsPageModals`, `useMaterialsBrowser`, `useMaterialsViewMode` などのカスタムフックに分割済み。
- `MaterialsSearchTab.tsx` と `materials/page.tsx` は若干超過しているが許容範囲内。さらなる分割は低優先度。

---

## 2. パフォーマンス改善

### 2.1 実装済み

- **SetupGuard 最適化**: localStorage キャッシュで API 呼び出しを約 95% 削減、ドライブ喪失時は自動で `/setup` へ遷移。
- **グローバルキャッシュ**: `Folders/Categories/Users Context` が重複リクエストを防止。
- **お気に入り数一括取得 & 差分更新**: `since` パラメータで前回以降の更新分だけ取得。
- **画像・アバター最適化**: Next Image + WebP/AVIF、アバターを Base64 からファイル保存へ移行。
- **接続状態インジケーター**: 通知ポーリング結果を Live/Dead/Inactive 表示に反映。
- **ブラウザ戻る対応**: 階層ナビゲーションを URL へ反映し履歴操作が可能。

### 2.2 改善予定

1. **ページネーション（優先度: 中）**  
   - 資料/ユーザー一覧の初期ロードを 30 秒 → 2 秒へ短縮する狙い。API 側の `limit/offset` は実装済み。フィードバックページ（`/feedback`）とDB管理ページ（`/admin/database`）ではフロントエンド側のページネーションが実装済み。資料一覧（`/materials`）とユーザー一覧（`/members`）では未実装。
2. **バッチ取得 API（優先度: 中）**  
   - 作成者情報などを一括取得してリクエスト数を削減。現在は `UsersContext.getUsers()` で並列取得しているが、専用の `POST /api/users/batch` エンドポイントの実装を検討中。
3. **React Query / SWR（優先度: 低）**  
   - キャッシュとフェッチの戦略を統一し、データ一貫性を向上。現在はカスタムフックとContextで管理しているが、将来的な導入を検討。

---

## 3. セキュリティ懸念

- **認証情報の保存**: 現状はデバイストークン認証（証明ファイルベース）。デバイストークンファイルは各端末に保存され、将来的に保存が必要になった場合は暗号化ストレージを必須にする。
- **DB ファイルの権限**: ネットワークドライブ上の `{ドライブ}:\k_shot\shared\k_shot.db` には最小権限を設定。
- **API 権限チェック**: フロント側だけでなく全エンドポイントで権限検証（既に実装済みだが継続的なレビューが必要）。  
  - ⚠️ **注意**: 資料の編集（`PUT /api/materials/[id]`）と削除（`POST /api/trash`）には作成者/管理者権限チェックが実装されていない。コメントの編集・削除には実装済み（作成者のみ）。将来的に権限チェックを追加する必要がある。

---

## 4. 既知の問題

1. **materials ページで斜め線が表示される**  
   - 高解像度モニターで発生。アイコン要素が原因。機能影響はないため低優先度。
2. **閲覧数が即時反映されない**  
   - サーバー側では加算済みだが、フロントに楽観的更新が無い。UX 改善候補。

---

## 5. 将来の拡張計画

### 5.1 データ移行

- ✅ `departments.csv`, `user_activities`, `notifications`, `material_types`, `difficulty_levels`, `material_comments`, `material_revisions`, `feedback_metadata` → SQLite へ移行済み。
- ❗`skills.csv`, `tasks.csv` などは未移行。  
- 📂 JSON/CSV 管理のまま: `users/{user_id_hash}/bookmarks.json`, `data/trash/trash.csv`, `users/{user_id_hash}/feedback/feedback.json`（user_id_hashはuserIdをSHA256でハッシュ化した32文字の文字列）。

### 5.2 機能追加・設定拡張

- 学習課題 / 学習指示機能（未着手）。  
- テーマ設定の永続化（現在は localStorage のみ）。  
- 設定変更履歴、デフォルトリセット、データ同期ポーリング設定、API タイムアウト設定など。

---

## 6. 今後の検討事項

1. **データ管理**: スキーマバージョニング、整合性チェック、古いログの圧縮。
2. **機能改善**: ゴミ箱復元時の安全性向上、ログ検索の強化、設定変更の承認フロー。
3. **パフォーマンス**: ドライブレター検出の最適化、仮想スクロール、Redis 等のサーバーサイドキャッシュ、GraphQL 検討。
4. **その他**: エラーハンドリングの詳細化、学習課題/指示機能の実装など。

---

## 7. まとめと推奨アクション

- 大規模リファクタリングは完了。主要ファイルはカスタムフック化により設計指針に収まりました。
- 次の中優先度タスク: フロントエンド側でのページネーション実装、バッチ取得 API の追加実装。
- 長期的には React Query や仮想スクロール導入、JSON/CSV データの DB 化を検討。
- UX 由来の軽微な問題（斜め線、閲覧数反映）も backlog に入れておき、時間を見て改善する。

気付いた懸念・改善案は本ページに追記してください。

